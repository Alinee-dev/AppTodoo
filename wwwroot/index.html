<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Inicio</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=home" />
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#ffffff">
    <script>
        if ('serviceWorker' in navigator) {
            // ‚úÖ Registrar Service Worker
            navigator.serviceWorker.register('/TodoApp/service-worker.js')
                .then(() => console.log("‚úÖ Service Worker registrado"))
                .catch(err => console.error("‚ùå Error al registrar SW:", err));

            // üì¢ Escuchar si el SW avisa una nueva versi√≥n
            navigator.serviceWorker.addEventListener("message", (event) => {
                if (event.data && event.data.type === "NEW_VERSION") {
                    console.log("üÜï Nueva versi√≥n disponible");
                    const msg = document.createElement("div");
                    msg.textContent = "üîÑ Actualizando Apptodo...";
                    msg.style.position = "fixed";
                    msg.style.bottom = "20px";
                    msg.style.left = "50%";
                    msg.style.transform = "translateX(-50%)";
                    msg.style.background = "#2ecc71";
                    msg.style.color = "white";
                    msg.style.padding = "12px 20px";
                    msg.style.borderRadius = "10px";
                    msg.style.fontWeight = "bold";
                    msg.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
                    msg.style.zIndex = "9999";
                    document.body.appendChild(msg);

                    setTimeout(() => window.location.reload(), 1500);
                }
            });
        }
    </script>


    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            padding: 20px;
            padding-bottom: 80px; /* espacio para el bottom bar */
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: auto;
            position: relative;
            padding-top: 20px;
        }


        /* --- ESTILO PARA EL BOT√ìN DE CONFIGURACI√ìN FIJO --- */
        #settings-button-fixed {
            position: absolute;
            top: 20px; /* Distancia desde la parte superior */
            right: 20px; /* Distancia desde la derecha */

            background: none;
            border: none;
            color: #3498db;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            padding: 5px;
            transition: transform 0.2s;
        }

            #settings-button-fixed:hover {
                transform: scale(1.1);
            }


        /* Fin de estilos del bot√≥n fijo */
        .main-greeting {
            color: #2c3e50;
            margin-bottom: 10px;
            margin-top: -10px; /* Ya no necesitamos margen superior porque el container lo compensa */
        }


        .tasks-summary-widget,
        .events-widget,
        .habits-widget { /* WIDGET */
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
            border-left: 5px solid #3498db;
        }

        .widget-title {
            color: #34495e;
            margin-top: 0;
            font-size: 1.3rem;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


        /* === ESTILOS PARA HABIT TRACKER === */
        #add-habit-btn {
            background: none;
            border: none;
            color: #3498db;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            font-weight: bold;
            outline: none;
        }

        #habits-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-around;
        }

        .habit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 80px;
            position: relative;
        }

        .habit-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ecf0f1; /* Gris claro (No completado) */
            border: 2px solid #bdc3c7;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            transition: background-color 0.3s, border-color 0.3s;
            position: relative;
            cursor: pointer;
        }

            .habit-circle.completed {
                background-color: #2ecc71; /* Verde (Completado) */
                border-color: #27ae60;
            }

        .habit-name {
            font-size: 0.8rem;
            color: #34495e;
            line-height: 1.2;
        }


        /* FIN DE ESTILOS DE H√ÅBITOS */

        /* --- ESTILOS PARA EL NUEVO WIDGET MENSTRUAL (COMPACTO) --- */
        .menstrual-widget {
            /* Mantiene el estilo de tarjeta blanca */
            background-color: #ffffff;
            color: #34495e;
            padding: 15px; /* COMPACTO: Menos padding general */
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-top: 15px; /* COMPACTO: Menos margen superior */
            border-left: 5px solid #e74c3c;
        }

            .menstrual-widget h3 {
                font-size: 1.2rem; /* COMPACTO: T√≠tulo m√°s peque√±o */
                color: #e74c3c;
                border-bottom: none;
                padding-bottom: 0;
                margin-bottom: 10px; /* COMPACTO: Menos margen inferior */
                font-weight: 700;
            }

        .menstrual-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px; /* COMPACTO: Espacio reducido */
            margin-bottom: 10px; /* COMPACTO: Espacio reducido */
        }

        .stat-card {
            background-color: #ecf0f1;
            padding: 10px; /* COMPACTO: Menos padding interno */
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        }

            .stat-card p {
                margin: 0 0 3px 0;
                font-size: 0.8rem; /* COMPACTO: Fuente m√°s peque√±a para la etiqueta */
                color: #7f8c8d;
            }

            .stat-card strong {
                font-size: 1.1rem; /* COMPACTO: Reducci√≥n del n√∫mero principal */
                font-weight: 900;
                line-height: 1.1;
                color: #e74c3c;
            }

        .phase-card {
            /* Mantenemos el contraste, pero reducimos padding */
            background: linear-gradient(90deg, #ff69b4 0%, #d81b60 100%);
            color: white;
            padding: 12px; /* COMPACTO: Padding reducido */
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
        }

            .phase-card h4 {
                margin-top: 0;
                font-size: 1.1rem; /* COMPACTO: T√≠tulo de fase m√°s peque√±o */
                font-weight: 700;
                line-height: 1.2;
            }

            .phase-card p {
                margin: 3px 0 0 0;
                font-size: 0.9rem; /* COMPACTO: Descripci√≥n de fase m√°s peque√±a */
                opacity: 0.9;
            }

        .register-period-btn {
            /* Bot√≥n m√°s peque√±o */
            width: 100%;
            padding: 12px; /* COMPACTO: Padding reducido */
            font-size: 1rem; /* COMPACTO: Fuente m√°s peque√±a */
            font-weight: bold;
            color: white;
            background: linear-gradient(90deg, #ff1493 0%, #d81b60 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(255, 0, 100, 0.4);
            transition: transform 0.2s;
        }

            .register-period-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(255, 0, 100, 0.5);
            }


        /* FIN ESTILOS MENSTRUALES AJUSTADOS */

        /* Habilitar clic en el t√≠tulo para abrir el modal */
        .habits-widget .widget-title {
            cursor: pointer;
        }

        .summary-amount {
            font-size: 2rem;
            font-weight: bold;
        }


        /* === ESTILOS PARA EL MODAL DE GESTI√ìN DE H√ÅBITOS Y CONFIGURACI√ìN === */
        #habits-management-modal, #app-settings-modal, #initial-period-date-modal {
            display: none; /* Ocultar por defecto */
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Fondo semi-transparente */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* 5% desde arriba y centrado */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -10px;
        }

            .modal-close-btn:hover,
            .modal-close-btn:focus {
                color: #34495e;
                text-decoration: none;
            }

        .management-list {
            list-style: none;
            padding: 0;
        }


        /* Estilo para cada √≠tem de la lista en el modal */
        .management-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
        }

            .management-list-item:last-child {
                border-bottom: none;
            }

            .management-list-item span:first-child {
                flex-grow: 1;
                padding-right: 10px;
            }

        .delete-habit-btn-modal {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

            .delete-habit-btn-modal:hover {
                background: #c0392b;
            }


        /* Estilos espec√≠ficos para configuraci√≥n */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

            .setting-item label {
                font-weight: bold;
                color: #34495e;
            }

            .setting-item input[type="number"] {
                width: 60px;
                padding: 5px;
                text-align: center;
                border: 1px solid #ccc;
                border-radius: 4px;
            }


        /* Estilo del Switch (Toggle) */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

            .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }

        input:checked + .slider {
            background-color: #2ecc71;
        }

            input:checked + .slider:before {
                transform: translateX(26px);
            }


        /* FIN ESTILOS MODAL */

        /* ===============================
            Bottom Bar (MEJORADO PARA ACTIVO)
        ============================== */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f5f5f5;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* <- IMPORTANTE */
            box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
            border-top: 1px solid #ddd;
            z-index: 9999;
        }

            .bottom-bar a {
                color: #444;
                text-decoration: none;
                display: flex;
                flex-direction: column;
                align-items: center;
                font-size: 12px;
                transition: 0.3s;
                padding: 5px 10px; /* A√±adido para el borde activo */
                border-radius: 8px; /* A√±adido para el borde activo */
                border: 2px solid transparent; /* BASE */
            }

                .bottom-bar a svg {
                    font-size: 28px;
                    margin-bottom: 4px;
                    transition: transform 0.2s, color 0.2s;
                    fill: #555; /* Color del SVG por defecto */
                }

                /* Resaltado para el enlace activo */
                .bottom-bar a.active {
                    /* Color de fondo/borde para la pesta√±a activa */
                    border: 2px solid #3498db;
                    background-color: #ebf5fb;
                    color: #3498db;
                }

                    .bottom-bar a.active svg {
                        transform: translateY(-3px) scale(1.05); /* Ligeramente m√°s grande y levantado */
                        fill: #3498db; /* Color del SVG activo */
                    }

                /* Resaltado al pasar el rat√≥n (Hover) */
                .bottom-bar a:hover svg {
                    transform: translateY(-2px);
                    fill: #3498db;
                }


        @media (max-width: 768px) {
            .bottom-bar {
                padding: 8px 0;
            }
        }


        /* CORRECCI√ìN PARA CELULARES */
        @media (max-width: 600px) {
            .bottom-bar a {
                font-size: 10px; /* Reducir fuente un poco para m√≥viles */
                padding: 5px; /* Ajustar padding */
            }

            .bottom-bar svg {
                width: 28px;
                height: 28px;
            }


            /* Asegurar que la barra tenga un padding adecuado en la parte inferior */
            .bottom-bar {
                padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
            }
        }

        .events-widget .event-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

            .events-widget .event-list li {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #eee;
                font-size: 1rem;
                color: #34495e;
            }

            .events-widget .event-list .event-date {
                font-weight: bold;
                color: #3498db; /*color de la fecha*/
                font-size: 0.9rem;
            }

        /* === ESTILOS DE LA LISTA DE TAREAS (SOLO TAREAS, SIN VI√ëETAS) === */

        .tasks-summary-widget .task-summary-list {
            list-style: none; /* Elimina vi√±etas por defecto */
            padding: 0; /* Elimina padding izquierdo del UL */
            margin-top: 5px;
        }

            .tasks-summary-widget .task-summary-list li {
                /* Alineaci√≥n y separaci√≥n para cada tarea */
                color: #34495e;
                font-size: 1rem;
                padding: 8px 0;
                border-bottom: 1px solid #f0f0f0;
                display: flex;
                align-items: center;
                position: relative;
            }

                /* Eliminamos el elemento ::before (el punto azul) */
                .tasks-summary-widget .task-summary-list li:before {
                    content: none; /* Elimina el punto/vi√±eta */
                }

                /* Asegurar que la √∫ltima tarea no tenga l√≠nea divisoria */
                .tasks-summary-widget .task-summary-list li:last-child {
                    border-bottom: none;
                }
    </style>
</head>

<body>

    <button id="settings-button-fixed" onclick="openAppSettings()">
        ‚öôÔ∏è
    </button>

    <div class="container">
        <h1 class="main-greeting">Hola<span id="greeting-name"></span></h1>
        <p id="current-date" style="color: #444; margin-top: -10px;"></p>
        <p id="motivational-quote" style="font-style: italic; color: #7f8c8d; margin-top: 15px;"></p>

        <div class="habits-widget">
            <h2 class="widget-title" id="open-habits-management">
                Mis H√°bitos Diarios üí™
                <button id="add-habit-btn">+</button>
            </h2>
            <div id="habits-list">
            </div>
            <p id="no-habits-message" style="color: #7f8c8d; text-align: center; padding: 5px; display: none;">
                ¬°A√±ade tu primer h√°bito con el bot√≥n '+'! üåü
            </p>
        </div>

        <div id="menstrual-tracker-container">
        </div>

        <div class="tasks-summary-widget">
            <h2 class="widget-title">Tareas Pendientes üéØ</h2>
            <ul id="upcoming-tasks-list" class="task-summary-list"></ul>
            <p id="no-tasks-message" style="display: none; color: #7f8c8d; text-align: center; padding: 5px;">
                ¬°Gran trabajo! Tareas completadas. ‚úÖ
            </p>
        </div>

        <div class="events-widget">
            <h2 class="widget-title">Pr√≥ximos Eventos üóìÔ∏è</h2>
            <ul id="upcoming-events-list" class="event-list">
                <li id="events-loading">Cargando eventos...</li>
            </ul>
            <p id="no-events-message" style="display: none; color: #7f8c8d; text-align: center; padding: 10px;">
                ¬°Genial! No hay eventos pr√≥ximos. üéâ
            </p>
        </div>
    </div>

    <div class="bottom-bar">
        <a href="index.html" class="active">
            <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z" /></svg>
        </a>
        <a href="Calendario.html">
            <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z" /></svg>
        </a>
        <a href="Tareas.html">
            <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm80-80h280v-80H280v80Zm0-160h400v-80H280v80Zm0-160h400v-80H280v80Zm200-190q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790ZM200-200v-560 560Z" /></svg>
        </a>
        <a href="Diario.html">
            <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px"><path d="M560-564v-68q33-14 67.5-21t72.5-7q26 0 51 4t49 10v64q-24-9-48.5-13.5T700-600q-38 0-73 9.5T560-564Zm0 220v-68q33-14 67.5-21t72.5-7q26 0 51 4t49 10v64q-24-9-48.5-13.5T700-380q-38 0-73 9t-67 27Zm0-110v-68q33-14 67.5-21t72.5-7q26 0 51 4t49 10v64q-24-9-48.5-13.5T700-490q-38 0-73 9.5T560-454ZM260-320q47 0 91.5 10.5T440-278v-394q-41-24-87-36t-93-12q-36 0-71.5 7T120-692v396q35-12 69.5-18t70.5-6Zm260 42q44-21 88.5-31.5T700-320q36 0 70.5 6t69.5 18v-396q-33-14-68.5-21t-71.5-7q-47 0-93 12t-87 36v394Zm-40 118q-48-38-104-59t-116-21q-42 0-82.5 11T100-198q-21 11-40.5-1T40-234v-482q0-11 5.5-21T62-752q46-24 96-36t102-12q58 0 113.5 15T480-740q51-30 106.5-45T700-800q52 0 102 12t96 36q11 5 16.5 15t5.5 21v482q0 23-19.5 35t-40.5 1q-37-20-77.5-31T700-240q-60 0-116 21t-104 59ZM280-494Z" /></svg>
        </a>
        <a href="Finanzas.html">
            <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px"><path d="M240-160q-66 0-113-47T80-320v-320q0-66 47-113t113-47h480q66 0 113 47t47 113v320q0 66-47 113t-113 47H240Zm0-480h480q22 0 42 5t38 16v-21q0-33-23.5-56.5T720-720H240q-33 0-56.5 23.5T160-640v21q18-11 38-16t42-5Zm-74 130 445 108q9 2 18 0t17-8l139-116q-11-15-28-24.5t-37-9.5H240q-26 0-45.5 13.5T166-510Z" /></svg>
        </a>
        <a href="Perfil.html">
            <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z" /></svg>
        </a>
    </div>

    <div id="habits-management-modal">
        <div class="modal-content">
            <span class="modal-close-btn" id="close-modal-btn">&times;</span>
            <h2>Gesti√≥n de H√°bitos</h2>
            <ul class="management-list" id="management-habits-list">
                <li style="text-align: center; color: #7f8c8d;">No hay h√°bitos para gestionar.</li>
            </ul>
            <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 15px;">
                * Clic en el bot√≥n **`+`** en el inicio para a√±adir nuevos h√°bitos.
            </p>
        </div>
    </div>

    <div id="app-settings-modal">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeAppSettings()">&times;</span>
            <h2>‚öôÔ∏è Configuraci√≥n</h2>

            <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">Seguimiento Menstrual</h3>

            <div class="setting-item">
                <label for="menstrual-toggle">Activar M√≥dulo</label>
                <label class="switch">
                    <input type="checkbox" id="menstrual-toggle" onchange="toggleMenstrualTracker(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="menstrual-settings-inputs" style="margin-top: 10px; padding: 10px; border: 1px dashed #e74c3c88; border-radius: 5px; display: none;">
                <p style="font-size: 0.9em; margin-top: 0;">Estos datos se usan para estimar tu pr√≥ximo ciclo.</p>

                <div class="setting-item">
                    <label for="cycle-length-input">Duraci√≥n promedio del ciclo (d√≠as):</label>
                    <input type="number" id="cycle-length-input" min="20" max="45" value="28">
                </div>

                <div class="setting-item" style="border-bottom: none;">
                    <label for="period-length-input">Duraci√≥n promedio del periodo (d√≠as):</label>
                    <input type="number" id="period-length-input" min="2" max="10" value="5">
                </div>

                <button onclick="saveCycleSettingsFromModal()" style="width: 100%; padding: 10px; background-color: #3498db; color: white; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer;">
                    Guardar Ajustes de Ciclo
                </button>
            </div>

            <h3 style="border-bottom: 1px solid #eee; padding-top: 20px; padding-bottom: 10px;">Otras Opciones</h3>
            <button onclick="localStorage.removeItem('userName'); window.location.reload();" style="background: none; border: none; color: #e74c3c; cursor: pointer; text-decoration: underline;">
                Reiniciar Nombre de Usuario
            </button>

        </div>
    </div>

    <div id="initial-period-date-modal" class="modal-container">
        <div class="modal-content" style="max-width: 350px;">
            <span class="modal-close-btn" onclick="closeInitialDateModal()">&times;</span>
            <h2 style="font-size: 1.5rem;">üìÖ Iniciar Seguimiento</h2>
            <p style="color: #7f8c8d; margin-bottom: 15px;">Ingresa la fecha de **inicio** de tu √∫ltimo periodo:</p>

            <input type="date" id="last-period-date-input" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px; font-size: 1.1rem;">

            <button onclick="submitInitialPeriodDate()" class="register-period-btn" style="padding: 10px;">
                Guardar Fecha
            </button>
        </div>
    </div>


    <script>
        // Declaraci√≥n del estado global para el toggle
        let isMenstrualCardVisible = false; // Ya no se usa para el toggle, pero se mantiene por seguridad

        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. Bienvenida ---
            let userName = localStorage.getItem('userName');
            const greetingElement = document.getElementById('greeting-name');

            if (!userName) {
                userName = prompt("¬°Bienvenido! Por favor, ingresa tu nombre:");
                if (userName && userName.trim() !== "") {
                    localStorage.setItem('userName', userName.trim());
                } else { userName = "Usuario"; }
            }

            if (greetingElement) {
                greetingElement.textContent = " " + userName.trim() + "!";
            }

            // --- 2. Fecha ---
            const dateElement = document.getElementById('current-date');
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = today.toLocaleDateString('es-ES', options);
            dateElement.textContent = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);

            // --- 3. Frase motivacional (Actualizaci√≥n Diaria) ---
            const quoteElement = document.getElementById('motivational-quote');
            const quotes = [
                "El √∫nico modo de hacer un gran trabajo es amar lo que haces. üöÄ",
                "El √©xito no es la clave de la felicidad. La felicidad es la clave del √©xito. ‚ú®",
                "Empieza donde est√°s. Usa lo que tienes. Haz lo que puedes. üí™",
                "La mejor forma de predecir el futuro es cre√°ndolo. üí°",
                "No dejes que el miedo de perder sea mayor que la emoci√≥n de ganar. ü•á",
                "Un viaje de mil millas comienza con un solo paso. üë£",
                "El fracaso es solo la oportunidad de comenzar de nuevo, pero con m√°s inteligencia. üß†",
                "Cree en ti, incluso cuando nadie m√°s lo haga. ‚ú®",
                "Con cada amanecer, tienes una nueva oportunidad para ser feliz. üåÖ",
                "Cada nuevo d√≠a es una nueva oportunidad para cambiar tu vida. üóìÔ∏è"
            ];

            // Obtener la fecha de hoy en formato YYYY-MM-DD
            const todayDateKey = today.toISOString().slice(0, 10);
            const storedQuote = localStorage.getItem('dailyQuote');
            const storedDate = localStorage.getItem('dailyQuoteDate');
            let finalQuote = "";

            if (storedDate === todayDateKey && storedQuote) {
                finalQuote = storedQuote;
            } else {
                const newQuote = quotes[Math.floor(Math.random() * quotes.length)];
                finalQuote = newQuote;
                localStorage.setItem('dailyQuote', newQuote);
                localStorage.setItem('dailyQuoteDate', todayDateKey);
            }

            quoteElement.textContent = `"${finalQuote}"`;

            // --- 4. H√ÅBITOS FUNCIONES ---
            const isEmoji = (str) => /\p{Emoji}/u.test(str);

            function getHabitsList() {
                const storedHabits = JSON.parse(localStorage.getItem('userHabits'));
                return storedHabits || [];
            }

            function saveHabitsList(habits) {
                localStorage.setItem('userHabits', JSON.stringify(habits));
            }

            function getDailyHabitKey() {
                const todayString = today.toISOString().slice(0, 10);
                return `habits_state_${todayString}`;
            }

            function loadDailyHabitState() {
                return JSON.parse(localStorage.getItem(getDailyHabitKey())) || {};
            }

            function saveDailyHabitState(state) {
                localStorage.setItem(getDailyHabitKey(), JSON.stringify(state));
            }

            function addHabit() {
                const habitEmoji = prompt("1/2: Ingresa el EMOJI (ej: üßò) para el nuevo h√°bito:");
                if (!habitEmoji || habitEmoji.trim() === "") return;

                const habitName = prompt("2/2: Ingresa el NOMBRE del h√°bito (ej: Meditar 10 min):");
                if (!habitName || habitName.trim() === "") return;

                const finalEmoji = Array.from(habitEmoji.trim())[0] || '?';

                const habitsList = getHabitsList();
                const newId = Date.now().toString();

                habitsList.push({ id: newId, emoji: finalEmoji, name: habitName.trim() });
                saveHabitsList(habitsList);
                renderHabits();
            }

            function deleteHabit(habitId) {
                const habitList = getHabitsList();
                const habitToDelete = habitList.find(h => h.id === habitId);

                if (!confirm(`¬øEst√°s seguro de que quieres eliminar el h√°bito: "${habitToDelete.name}"? Esta acci√≥n es irreversible.`)) {
                    return;
                }

                let habitsList = habitList.filter(h => h.id !== habitId);
                saveHabitsList(habitsList);

                const currentDailyState = loadDailyHabitState();
                if (currentDailyState.hasOwnProperty(habitId)) {
                    delete currentDailyState[habitId];
                    saveDailyHabitState(currentDailyState);
                }

                renderHabits();
                renderManagementList();
            }


            function renderHabits() {
                const habitsListElement = document.getElementById('habits-list');
                const noHabitsMessage = document.getElementById('no-habits-message');
                const habitsList = getHabitsList();
                const habitState = loadDailyHabitState();

                habitsListElement.innerHTML = '';

                if (habitsList.length === 0) {
                    noHabitsMessage.style.display = 'block';
                } else {
                    noHabitsMessage.style.display = 'none';
                    habitsList.forEach(habit => {
                        const isCompleted = habitState[habit.id] || false;

                        const emojiToShow = habit.emoji || '?';
                        const nameToShow = habit.name || 'Sin Nombre';

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'habit-item';
                        itemDiv.dataset.habitId = habit.id;

                        const circleDiv = document.createElement('div');
                        circleDiv.className = `habit-circle ${isCompleted ? 'completed' : ''}`;
                        circleDiv.id = `habit-circle-${habit.id}`;
                        circleDiv.addEventListener('click', () => toggleHabit(habit.id));

                        if (!isCompleted) {
                            circleDiv.textContent = emojiToShow;
                            circleDiv.style.fontSize = isEmoji(emojiToShow) ? '25px' : '1.5rem';
                            circleDiv.style.color = '#34495e';
                        } else {
                            circleDiv.textContent = '‚úî';
                            circleDiv.style.fontSize = '20px';
                            circleDiv.style.color = 'white';
                        }

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'habit-name';
                        nameSpan.textContent = nameToShow;

                        itemDiv.appendChild(circleDiv);
                        itemDiv.appendChild(nameSpan);
                        habitsListElement.appendChild(itemDiv);
                    });
                }
            }

            function renderManagementList() {
                const managementList = document.getElementById('management-habits-list');
                const habitsList = getHabitsList();
                managementList.innerHTML = '';

                if (habitsList.length === 0) {
                    managementList.innerHTML = '<li style="text-align: center; color: #7f8c8d;">No hay h√°bitos para gestionar.</li>';
                    return;
                }

                habitsList.forEach(habit => {
                    const listItem = document.createElement('li');
                    listItem.className = 'management-list-item';

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = (habit.emoji || '?') + ' ' + (habit.name || 'Sin Nombre');

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-habit-btn-modal';
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.addEventListener('click', () => deleteHabit(habit.id));

                    listItem.appendChild(nameSpan);
                    listItem.appendChild(deleteBtn);
                    managementList.appendChild(listItem);
                });
            }

            function openHabitsManagement() {
                renderManagementList();
                document.getElementById('habits-management-modal').style.display = 'block';
            }

            function closeHabitsManagement() {
                document.getElementById('habits-management-modal').style.display = 'none';
                renderHabits();
            }

            function toggleHabit(habitId) {
                const habitState = loadDailyHabitState();
                const habitList = getHabitsList();
                const habitData = habitList.find(h => h.id === habitId);

                if (!habitData) return;

                habitState[habitId] = !habitState[habitId];

                saveDailyHabitState(habitState);

                const circle = document.getElementById(`habit-circle-${habitId}`);

                if (circle) {
                    if (habitState[habitId]) {
                        circle.classList.add('completed');
                        circle.textContent = '‚úî';
                        circle.style.fontSize = '20px';
                        circle.style.color = 'white';
                    } else {
                        circle.classList.remove('completed');
                        const emojiToShow = habitData.emoji || '?';
                        circle.textContent = emojiToShow;
                        circle.style.fontSize = isEmoji(emojiToShow) ? '25px' : '1.5rem';
                        circle.style.color = '#34495e';
                    }
                }
            }

            // --- 5. CALENDARIO MENSTRUAL FUNCIONES (MODIFICADAS) ---

            const PREF_MENSTRUAL_KEY = 'isMenstrualTrackerActive';
            const LAST_PERIOD_KEY = 'menstrual_lastPeriodDate';
            const CYCLE_LENGTH_KEY = 'menstrual_cycleLength';
            const PERIOD_LENGTH_KEY = 'menstrual_periodLength';

            function isMenstrualTrackerActive() {
                return localStorage.getItem(PREF_MENSTRUAL_KEY) === 'true';
            }

            function toggleMenstrualTracker(isActive) {
                localStorage.setItem(PREF_MENSTRUAL_KEY, isActive ? 'true' : 'false');

                const inputsDiv = document.getElementById('menstrual-settings-inputs');
                if (inputsDiv) {
                    inputsDiv.style.display = isActive ? 'block' : 'none';
                }

                if (!isActive) {
                    localStorage.removeItem(LAST_PERIOD_KEY);
                    // Ya no ocultamos aqu√≠, el renderizado principal lo gestiona.
                }
                renderMenstrualTrackerCard();
            }

            function saveCycleSettings(cycleLength, periodLength) {
                localStorage.setItem(CYCLE_LENGTH_KEY, cycleLength);
                localStorage.setItem(PERIOD_LENGTH_KEY, periodLength);
            }

            function getCycleSettings() {
                return {
                    cycleLength: parseInt(localStorage.getItem(CYCLE_LENGTH_KEY) || '28'),
                    periodLength: parseInt(localStorage.getItem(PERIOD_LENGTH_KEY) || '5')
                };
            }

            function saveCycleSettingsFromModal() {
                const cycleLength = document.getElementById('cycle-length-input').value;
                const periodLength = document.getElementById('period-length-input').value;
                saveCycleSettings(cycleLength, periodLength);
                alert("Ajustes de ciclo guardados.");
                renderMenstrualTrackerCard();
            }

            /**
             * Muestra el modal del calendario para ingresar la fecha inicial.
             */
            function promptForLastPeriod() {
                // Solo se ejecuta si est√° activo y no hay fecha guardada
                if (!isMenstrualTrackerActive() || localStorage.getItem(LAST_PERIOD_KEY)) return;

                // Abre el modal del calendario
                document.getElementById('initial-period-date-modal').style.display = 'block';
            }

            /**
             * Maneja la acci√≥n de guardar la fecha desde el input de calendario.
             */
            function submitInitialPeriodDate() {
                const input = document.getElementById('last-period-date-input');
                const dateValue = input.value;

                if (!dateValue) {
                    alert("Por favor, selecciona una fecha v√°lida.");
                    return;
                }

                // Guardar la fecha del input de tipo date
                localStorage.setItem(LAST_PERIOD_KEY, dateValue);

                closeInitialDateModal();
                alert(`¬°Registro inicial exitoso!`);
                renderMenstrualTrackerCard();
            }

            /**
             * Cierra el modal de fecha inicial.
             */
            function closeInitialDateModal() {
                document.getElementById('initial-period-date-modal').style.display = 'none';
            }


            /**
             * Registra la fecha de hoy como inicio del √∫ltimo periodo autom√°ticamente (usado en el bot√≥n).
             */
            function registerPeriodToday() {
                if (!isMenstrualTrackerActive()) return;

                const today = new Date();
                const todayString = today.toISOString().slice(0, 10);

                localStorage.setItem(LAST_PERIOD_KEY, todayString);
                alert(`¬°Periodo registrado! Nuevo ciclo iniciado`);
                renderMenstrualTrackerCard();
            }


            function calculateCycleDates() {
                const lastPeriodDate = localStorage.getItem(LAST_PERIOD_KEY);

                if (!lastPeriodDate || !isMenstrualTrackerActive()) return null;

                const { cycleLength, periodLength } = getCycleSettings();
                const lastStart = new Date(lastPeriodDate);

                if (isNaN(lastStart.getTime())) return null;

                const nextStart = new Date(lastStart);
                nextStart.setDate(lastStart.getDate() + cycleLength);

                const periodEnd = new Date(lastStart);
                periodEnd.setDate(lastStart.getDate() + periodLength - 1);

                const ovulationDate = new Date(nextStart);
                ovulationDate.setDate(nextStart.getDate() - 14);

                return {
                    lastStart: lastStart,
                    periodEnd: periodEnd,
                    nextStart: nextStart,
                    ovulation: ovulationDate,
                    cycleLength: cycleLength,
                    periodLength: periodLength
                };
            }

            function formatDate(dateObject) {
                if (!(dateObject instanceof Date) || isNaN(dateObject.getTime())) return 'N/A';
                const day = dateObject.getDate().toString().padStart(2, '0');
                const month = (dateObject.getMonth() + 1).toString().padStart(2, '0');
                return `${day}/${month}/${dateObject.getFullYear()}`;
            }

            // FUNCI√ìN DE RENDERIZADO PRINCIPAL (MOSTRAR SIEMPRE si est√° activo)
            function renderMenstrualTrackerCard() {
                const container = document.getElementById('menstrual-tracker-container');
                if (!container) return;
                container.innerHTML = '';

                if (!isMenstrualTrackerActive()) {
                    return;
                }

                const lastPeriodDate = localStorage.getItem(LAST_PERIOD_KEY);
                const registerButtonHtml = `
                                                <button onclick="registerPeriodToday()" class="register-period-btn">
                                                    ü©∏ Registrar inicio de per√≠odo hoy
                                                </button>`;

                // 1. Estado: M√≥dulo Activo, Faltan Datos (Inicializaci√≥n)
                if (!lastPeriodDate) {
                    // Llama al modal para la entrada inicial
                    promptForLastPeriod();

                    // Renderiza el estado de espera y la opci√≥n de ingresar manualmente/autom√°tico.
                    container.innerHTML = `
                                                <div class="menstrual-widget" style="text-align: center;">
                                                    <h3>Registro del Ciclo Menstrual ü©∏</h3>
                                                    <p style="color: #7f8c8d; margin-bottom: 10px;">Ingresa la fecha de tu √∫ltimo periodo para empezar.</p>
                                                    ${registerButtonHtml}
                                                    <p style="text-align: center; margin-top: 10px; font-size: 0.8em; color: #7f8c8d;">
                                                        O <span onclick="promptForLastPeriod()" style="text-decoration:underline; cursor:pointer; color:#e74c3c;">ingresa una fecha anterior.</span>
                                                    </p>
                                                </div>
                                                `;
                    return;
                }

                // Si llegamos aqu√≠, los datos deben existir.
                const cycleData = calculateCycleDates();

                if (!cycleData) {
                    // Failsafe
                    container.innerHTML = `<div class="menstrual-widget"><h3>Error</h3><p>No se pudo calcular el ciclo. Revisa la fecha o configuraci√≥n.</p></div>`;
                    return;
                }

                const today = new Date(todayDateKey);
                const timeToNext = Math.ceil((cycleData.nextStart - today) / (1000 * 60 * 60 * 24));
                const daysInCycle = Math.ceil((today - cycleData.lastStart) / (1000 * 60 * 60 * 24)) + 1;

                // --- L√ìGICA DE FASES ---
                let phaseTitle = "Fase L√∫tea";
                let phaseDescription = "Se prepara el cuerpo para la menstruaci√≥n. Podr√≠as sentir cambios de humor y antojos.";
                let phaseDays = `(D√≠as 15-${cycleData.cycleLength})`;

                const dayOfCycle = daysInCycle;
                const FOLLICULAR_END = 13;
                const OVULATION_WINDOW = 14;

                if (dayOfCycle <= cycleData.periodLength) {
                    phaseTitle = "Menstruaci√≥n";
                    phaseDescription = "Fase de sangrado. T√≥mate el tiempo para descansar y cuidarte.";
                    phaseDays = `(D√≠as 1-${cycleData.periodLength})`;
                } else if (dayOfCycle <= FOLLICULAR_END) {
                    phaseTitle = "Fase Folicular";
                    phaseDescription = "Aumenta el estr√≥geno; m√°s energ√≠a, concentraci√≥n y √°nimo.";
                    phaseDays = `(D√≠as ${cycleData.periodLength + 1}-${FOLLICULAR_END})`;
                } else if (dayOfCycle >= (OVULATION_WINDOW - 2) && dayOfCycle <= (OVULATION_WINDOW + 2)) {
                    phaseTitle = "Ventana de Ovulaci√≥n";
                    phaseDescription = "Pico de fertilidad y m√°xima energ√≠a social.";
                    phaseDays = `(D√≠as 12-16)`;
                }

                // --- RENDERIZADO ---
                container.innerHTML = `
                                                <div class="menstrual-widget">
                                                    <h3>Registro del Ciclo Menstrual ü©∏</h3>

                                                    <div class="menstrual-stats-grid">
                                                        <div class="stat-card">
                                                            <p>D√≠a del Ciclo</p>
                                                            <strong>${dayOfCycle}</strong>
                                                        </div>
                                                        <div class="stat-card">
                                                            <p>Pr√≥ximo Periodo</p>
                                                            <strong>${formatDate(cycleData.nextStart).slice(0, 5)}</strong> </div>
                                                    </div>

                                                    <div class="phase-card">
                                                        <h4>${phaseTitle} ${phaseDays}</h4>
                                                        <p>${phaseDescription}</p>
                                                    </div>

                                                    ${registerButtonHtml}

                                                    <p style="text-align: center; margin-top: 10px; font-size: 0.8em; color: #7f8c8d;">
                                                        Pr√≥xima Ovulaci√≥n estimada: ${formatDate(cycleData.ovulation).slice(0, 5)}
                                                        <br>
                                                        <span onclick="openAppSettings()" style="color: #e74c3c; cursor: pointer; text-decoration: underline;">Ajustar duraci√≥n de ciclo</span>
                                                    </p>

                                                </div>
                                                `;
            }

            // --- 6. MODAL DE CONFIGURACI√ìN DE LA APP (NUEVO) ---

            function loadAppSettings() {
                const is_active = isMenstrualTrackerActive();
                document.getElementById('menstrual-toggle').checked = is_active;

                const settings = getCycleSettings();
                document.getElementById('cycle-length-input').value = settings.cycleLength;
                document.getElementById('period-length-input').value = settings.periodLength;

                const inputsDiv = document.getElementById('menstrual-settings-inputs');
                if (inputsDiv) {
                    inputsDiv.style.display = is_active ? 'block' : 'none';
                }
            }

            window.openAppSettings = function () {
                loadAppSettings();
                document.getElementById('app-settings-modal').style.display = 'block';
            }

            window.closeAppSettings = function () {
                document.getElementById('app-settings-modal').style.display = 'none';
                renderMenstrualTrackerCard();
            }

            // Exposici√≥n de funciones al √°mbito global
            window.toggleMenstrualTracker = toggleMenstrualTracker;
            window.saveCycleSettingsFromModal = saveCycleSettingsFromModal;
            window.registerPeriodToday = registerPeriodToday;
            window.submitInitialPeriodDate = submitInitialPeriodDate;
            window.closeInitialDateModal = closeInitialDateModal;
            window.promptForLastPeriod = promptForLastPeriod;


            // --- 7. Tareas (MODIFICADA: Sin 'Total Pendiente') ---
            function loadUpcomingTasks() {
                const tasks = JSON.parse(localStorage.getItem('minimalToggleTodoTasks')) || [];
                const pendingListElement = document.getElementById('upcoming-tasks-list');
                const noTasksMessage = document.getElementById('no-tasks-message');

                // MODIFICACI√ìN: Ya NO se usa .slice(0, 5) para limitar el n√∫mero de tareas.
                const pendingTasks = tasks.filter(t => !t.completed);
                pendingListElement.innerHTML = '';

                if (pendingTasks.length > 0) {
                    noTasksMessage.style.display = 'none';

                    // **ELIMINADO:** const summaryLi = document.createElement('li');
                    // **ELIMINADO:** pendingListElement.appendChild(summaryLi);

                    // Solo agregamos las tareas individuales
                    pendingTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${task.text}</span>`;
                        pendingListElement.appendChild(li);
                    });
                } else {
                    noTasksMessage.style.display = 'block';
                }
            }

            // --- 8. Eventos (Sin cambios) ---
            function loadUpcomingEvents() {
                const eventsData = JSON.parse(localStorage.getItem('calendarEvents')) || {};
                const eventListElement = document.getElementById('upcoming-events-list');
                const noEventsMessage = document.getElementById('no-events-message');
                const loading = document.getElementById('events-loading');
                if (loading) loading.remove();

                const upcomingEvents = [];
                const now = new Date(); now.setHours(0, 0, 0, 0);

                for (const dateKey in eventsData) {
                    if (eventsData.hasOwnProperty(dateKey)) {
                        const parts = dateKey.split('-');
                        const eventDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        eventDate.setHours(0, 0, 0, 0);
                        if (eventDate.getTime() >= now.getTime()) {
                            eventsData[dateKey].forEach(e => upcomingEvents.push({ date: eventDate, name: e }));
                        }
                    }
                }

                upcomingEvents.sort((a, b) => a.date - b.date);
                eventListElement.innerHTML = '';

                if (upcomingEvents.length > 0) {
                    noEventsMessage.style.display = 'none';
                    upcomingEvents.slice(0, 5).forEach(event => {
                        const li = document.createElement('li');
                        const displayDate = event.date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }).toUpperCase();
                        li.innerHTML = `<span>${event.name}</span><span class="event-date">${displayDate}</span>`;
                        eventListElement.appendChild(li);
                    });
                } else { noEventsMessage.style.display = 'block'; }
            }

            // --- 9. INICIALIZACI√ìN FINAL ---

            // CONEXI√ìN DE EVENTOS (Corregida)
            document.getElementById('add-habit-btn').addEventListener('click', addHabit);
            document.getElementById('open-habits-management').addEventListener('click', openHabitsManagement);
            document.getElementById('close-modal-btn').addEventListener('click', closeHabitsManagement);

            renderHabits();
            loadUpcomingEvents();
            loadUpcomingTasks();
            renderMenstrualTrackerCard(); // Renderiza la tarjeta menstrual si est√° activa.
        });
    </script>
</body>
</html>